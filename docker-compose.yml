services:
  # ======================
  # üêò PostgreSQL Databases
  # ======================

  postgres-auth:
    image: postgres:15
    container_name: postgres-auth
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: ${POSTGRES_USER_AUTH:-auth_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_AUTH:-auth_pass}
    ports:
      - "5433:5432"
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
    networks:
      - homestock-network

  postgres-group:
    image: postgres:15
    container_name: postgres-group
    environment:
      POSTGRES_DB: group_db
      POSTGRES_USER: ${POSTGRES_USER_GROUP:-group_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_GROUP:-group_pass}
    ports:
      - "5434:5432"
    volumes:
      - postgres_group_data:/var/lib/postgresql/data
    networks:
      - homestock-network

  postgres-inventory:
    image: postgres:15
    container_name: postgres-inventory
    environment:
      POSTGRES_DB: inventory_db
      POSTGRES_USER: ${POSTGRES_USER_INVENTORY:-inventory_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_INVENTORY:-inventory_pass}
    ports:
      - "5435:5432"
    volumes:
      - postgres_inventory_data:/var/lib/postgresql/data
    networks:
      - homestock-network

  # ======================
  # üê¶ Kafka (Apache KRaft Mode)
  # ======================

  kafka:
    image: apache/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1
      KAFKA_CLUSTER_ID: kraft-cluster-id
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_LOG_DIRS: /var/lib/kafka/data
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - homestock-network
    restart: unless-stopped

  # ======================
  # üîê Auth Service
  # ======================

  auth-service:
    build:
      context: ./auth-service/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    depends_on:
      - postgres-auth
      - kafka
    ports:
      - "8082:8080"
    networks:
      - homestock-network
    restart: unless-stopped
    env_file:
      - ./auth-service/auth-service/.env

  # ======================
  # üë• Group Service
  # ======================

  group-service:
    build:
      context: ./group-service/group-service
      dockerfile: Dockerfile
    container_name: group-service
    depends_on:
      - postgres-group
      - kafka
    ports:
      - "8081:8080"
    networks:
      - homestock-network
    restart: unless-stopped
    env_file:
      - ./group-service/group-service/.env

  # ======================
  # üì¶ Inventory Service
  # ======================

  inventory-service:
    build:
      context: ./inventory-service/inventory-service
      dockerfile: Dockerfile
    container_name: inventory-service
    depends_on:
      - postgres-inventory
      - kafka
    ports:
      - "8083:8080"
    networks:
      - homestock-network
    restart: unless-stopped
    env_file:
      - ./inventory-service/inventory-service/.env

  # ======================
  # üåê Gateway
  # ======================

  gateway:
    build:
      context: ./gateway/gateway
      dockerfile: Dockerfile
    container_name: gateway
    depends_on:
      - group-service
      - auth-service
    ports:
      - "8080:8080"
    networks:
      - homestock-network
    restart: unless-stopped
    env_file:
      - ./gateway/gateway/.env

# ======================
# üóÑÔ∏è Volumes & Network
# ======================
volumes:
  postgres_auth_data:
  postgres_group_data:
  postgres_inventory_data:
  kafka_data:

networks:
  homestock-network:
    driver: bridge
